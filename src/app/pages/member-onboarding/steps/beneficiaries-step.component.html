
<div class="beneficiaries-step">
    <!-- Bootstrap alert for toast messages (replace with Angular alert logic if needed) -->
    <div class="step-header d-flex align-items-center justify-content-between mb-3">
        <button type="button" class="btn btn-success" (click)="showAddDialog()">
            <i class="bi bi-plus-lg me-1"></i> Add Beneficiary
        </button>
        <div>
            <ng-container *ngIf="beneficiaries().length > 0; else noBeneficiaries">
                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> {{ beneficiaries().length }} beneficiary(ies) added</span>
            </ng-container>
            <ng-template #noBeneficiaries>
                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i> No beneficiaries added yet</span>
            </ng-template>
        </div>
    </div>

    <ng-container *ngIf="loading()">
        <div class="d-flex align-items-center mb-3">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading beneficiaries...
        </div>
    </ng-container>

    <ng-container *ngIf="!loading() && beneficiaries().length === 0">
        <div class="empty-state text-center py-4">
            <i class="bi bi-person" style="font-size: 3rem; color: #6c757d;"></i>
            <h4>No beneficiaries added</h4>
            <p>Click "Add Beneficiary" to add your first beneficiary.</p>
        </div>
    </ng-container>

    <ng-container *ngIf="!loading() && beneficiaries().length > 0">
        <div class="table-responsive">
            <table class="table table-striped align-middle" style="min-width: 50rem;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Relationship</th>
                        <th>ID Number</th>
                        <th>Benefit %</th>
                        <th style="width: 120px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let beneficiary of beneficiaries()">
                        <td>{{ beneficiary.name || '-' }}</td>
                        <td>-</td>
                        <td>{{ beneficiary.identificationNumber || '-' }}</td>
                        <td>-</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" (click)="editBeneficiary(beneficiary)" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" (click)="deleteBeneficiary(beneficiary.id)" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </ng-container>

    <!-- Add/Edit Modal -->
    <div class="modal fade show" tabindex="-1" [ngStyle]="{ display: displayDialog ? 'block' : 'none', background: 'rgba(0,0,0,0.5)' }" *ngIf="displayDialog">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editMode() ? 'Edit Beneficiary' : 'Add Beneficiary' }}</h5>
                    <button type="button" class="btn-close" (click)="displayDialog = false"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Beneficiary Information</button>
                        </li>
                        <li class="nav-item" role="presentation" *ngIf="editMode() && currentBeneficiaryId()">
                            <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">Documents</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="info" role="tabpanel">
                            <form>
                                <div class="mb-3">
                                    <label for="name" class="form-label">Full Name *</label>
                                    <input id="name" [(ngModel)]="currentBeneficiary.name" name="name" placeholder="Enter full name" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="idNumber" class="form-label">ID Number (SA) *</label>
                                    <input id="idNumber" [(ngModel)]="currentBeneficiary.identificationNumber" name="idNumber" (ngModelChange)="onIdNumberChange()" placeholder="e.g. 0001015009087" maxlength="13" class="form-control" [class.is-invalid]="idInfo() && !idInfo()!.isValid" [class.is-valid]="idInfo() && idInfo()!.isValid" />
                                    <div *ngIf="idInfo() && !idInfo()!.isValid" class="invalid-feedback d-block">{{ idInfo()!.errorMessage }}</div>
                                    <div *ngIf="idInfo() && idInfo()!.isValid" class="valid-feedback d-block"><i class="bi bi-check-circle"></i> Valid SA ID Number</div>
                                </div>
                                <div *ngIf="parsedDateOfBirth()" class="mb-3">
                                    <label for="dob" class="form-label">Date of Birth (from ID)</label>
                                    <input id="dob" [value]="parsedDateOfBirth() | date:'dd/MM/yyyy'" disabled class="form-control" />
                                    <small class="text-muted">Age: {{ idInfo()?.age }} years</small>
                                </div>
                                <div *ngIf="parsedGender()" class="mb-3">
                                    <label for="gender" class="form-label">Gender (from ID)</label>
                                    <input id="gender" [value]="parsedGender()" disabled class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input id="email" [(ngModel)]="currentBeneficiary.email" name="email" type="email" placeholder="Enter email address" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input id="phone" [(ngModel)]="currentBeneficiary.phone1" name="phone1" placeholder="(012) 345-6789" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input id="address" [(ngModel)]="currentBeneficiary.address" name="address" placeholder="Enter address" class="form-control" />
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="docs" role="tabpanel" *ngIf="editMode() && currentBeneficiaryId()">
                            <div class="mb-3">
                                <div class="alert alert-info"><i class="bi bi-info-circle"></i> Upload supporting documents for this beneficiary (e.g., ID document, banking details)</div>
                                <form>
                                    <div class="mb-3">
                                        <label class="form-label">Document Type *</label>
                                        <select [(ngModel)]="selectedDocumentType" name="documentType" class="form-select">
                                            <option value="">Select document type</option>
                                            <option *ngFor="let type of documentTypes" [value]="type.value">{{ type.label }}</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">File *</label>
                                        <input type="file" (change)="onFileSelect($event)" accept=".pdf,.jpg,.jpeg,.png" class="form-control" />
                                        <div *ngIf="selectedFile" class="text-success mt-1"><i class="bi bi-check"></i> {{ selectedFile.name }}</div>
                                    </div>
                                    <button type="button" class="btn btn-primary" (click)="uploadBeneficiaryDocument()" [disabled]="!selectedDocumentType || !selectedFile">
                                        <span *ngIf="uploading(); else notUploading"><span class="spinner-border spinner-border-sm me-2"></span>Uploading...</span><ng-template #notUploading><i class="bi bi-upload"></i> Upload Document</ng-template>
                                    </button>
                                </form>
                            </div>
                            <div *ngIf="uploadedDocuments().length > 0" class="mt-4">
                                <h4>Uploaded Documents</h4>
                                <div *ngFor="let doc of uploadedDocuments(); trackBy: trackByDocId" class="d-flex align-items-center mb-2">
                                    <div class="flex-grow-1">
                                        <i class="bi bi-file-earmark"></i>
                                        <strong>{{ doc.description || 'Document' }}</strong>
                                        <small class="text-muted ms-2">{{ doc.fileName }}</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2" (click)="deleteBeneficiaryDocument(doc.id)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="displayDialog = false"><i class="bi bi-x"></i> Cancel</button>
                    <button type="button" class="btn btn-primary" (click)="saveBeneficiary()"><i class="bi bi-check"></i> Save</button>
                </div>
            </div>
        </div>
    </div>
</div>
