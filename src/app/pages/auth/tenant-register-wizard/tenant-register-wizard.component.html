<div class="registration-wizard-container">
    <!-- Alerts -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div *ngFor="let alert of alerts" class="alert alert-{{alert.type}} alert-dismissible fade show" role="alert">
            {{alert.message}}
            <button type="button" class="btn-close" (click)="dismissAlert(alert)" aria-label="Close"></button>
        </div>
    </div>

    <div class="wizard-card">
        <div class="card">
            <div class="card-header wizard-header">
                <h2>Create Your Account</h2>
                <p>Join us and start managing your funeral services</p>
            </div>

            <div class="card-body">
                <!-- Steps Navigation -->
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item" *ngFor="let step of wizardSteps; let i = index">
                        <a class="nav-link" [class.active]="activeIndex() === i" [class.disabled]="i > activeIndex()">
                            <span class="badge rounded-circle me-2" [class.bg-primary]="activeIndex() === i" [class.bg-secondary]="i !== activeIndex()">{{i + 1}}</span>
                            {{step}}
                        </a>
                    </li>
                </ul>

                <div class="wizard-content">
                    <!-- Step 1: Account Information -->
                    <div *ngIf="activeIndex() === 0 && accountForm" class="step-content">
                        <h3>Account Information</h3>
                        <form [formGroup]="accountForm" class="registration-form">
                            <div class="row g-3">
                                <!-- Organization Name -->
                                <div class="col-md-6">
                                    <label for="name" class="form-label">Organization Name *</label>
                                    <input 
                                        id="name" 
                                        type="text" 
                                        class="form-control"
                                        [class.is-invalid]="isFieldInvalid('name')"
                                        formControlName="name"
                                        placeholder="Enter organization name">
                                    <div *ngIf="isFieldInvalid('name')" class="invalid-feedback">
                                        {{ getFieldError('name') }}
                                    </div>
                                </div>

                                <!-- Tenant Type -->
                                <div class="col-md-6">
                                    <label for="tenantType" class="form-label">Organization Type *</label>
                                    <select 
                                        id="tenantType"
                                        class="form-select"
                                        [class.is-invalid]="isFieldInvalid('tenantType')"
                                        formControlName="tenantType">
                                        <option value="">Select type</option>
                                        <option *ngFor="let type of tenantTypes" [value]="type.value">{{type.label}}</option>
                                    </select>
                                    <div *ngIf="isFieldInvalid('tenantType')" class="invalid-feedback">
                                        {{ getFieldError('tenantType') }}
                                    </div>
                                </div>
                            </div>

                            <!-- Email -->
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="email" class="form-label">Email Address *</label>
                                    <input 
                                        id="email" 
                                        type="email" 
                                        class="form-control" 
                                        formControlName="email"
                                        [class.is-invalid]="isFieldInvalid('email')"
                                        placeholder="admin@example.com">
                                    <div *ngIf="isFieldInvalid('email')" class="invalid-feedback">
                                        {{ getFieldError('email') }}
                                    </div>
                                </div>

                                <!-- Domain -->
                                <div class="col-md-6">
                                    <label for="domain" class="form-label">Domain (Subdomain) *</label>
                                    <input 
                                        id="domain" 
                                        type="text" 
                                        class="form-control" 
                                        formControlName="domain"
                                        [class.is-invalid]="isFieldInvalid('domain')"
                                        placeholder="yourcompany">
                                    <small class="form-text text-muted">Your site will be: yourcompany.yourdomain.com</small>
                                    <div *ngIf="isFieldInvalid('domain')" class="invalid-feedback">
                                        {{ getFieldError('domain') }}
                                    </div>
                                </div>
                            </div>

                            <!-- Password -->
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                <label for="password" class="form-label">Password *</label>
                                <input 
                                    id="password"
                                    type="password"
                                    class="form-control"
                                    formControlName="password"
                                    [class.is-invalid]="isFieldInvalid('password')"
                                    placeholder="Enter password">
                                <div *ngIf="isFieldInvalid('password')" class="invalid-feedback">
                                    {{ getFieldError('password') }}
                                </div>
                            </div>

                            <!-- Confirm Password -->
                            <div class="col-md-6">
                                <label for="confirmPassword" class="form-label">Confirm Password *</label>
                                <input 
                                    id="confirmPassword"
                                    type="password"
                                    class="form-control"
                                    formControlName="confirmPassword"
                                    [class.is-invalid]="accountForm.errors?.['passwordMismatch'] && accountForm.get('confirmPassword')?.touched"
                                    placeholder="Confirm password">
                                <div *ngIf="accountForm.errors?.['passwordMismatch'] && accountForm.get('confirmPassword')?.touched" class="invalid-feedback">
                                    Passwords do not match
                                </div>
                            </div>

                            <!-- Registration Number -->
                            <div class="row g-3 mt-3">
                            <div class="col-md-12">
                                <label for="registrationNumber" class="form-label">Registration Number *</label>
                                <input 
                                    id="registrationNumber" 
                                    type="text" 
                                    class="form-control" 
                                    formControlName="registrationNumber"
                                    [class.is-invalid]="isFieldInvalid('registrationNumber')"
                                    placeholder="2023/123456/07">
                                <div *ngIf="isFieldInvalid('registrationNumber')" class="invalid-feedback">
                                    {{ getFieldError('registrationNumber') }}
                                </div>
                            </div>
                            </div>

                            <!-- Phone 1 -->
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                <label for="phone1" class="form-label">Primary Phone *</label>
                                <input 
                                    id="phone1" 
                                    type="tel" 
                                    class="form-control" 
                                    formControlName="phone1"
                                    [class.is-invalid]="isFieldInvalid('phone1')"
                                    placeholder="+27123456789">
                                <div *ngIf="isFieldInvalid('phone1')" class="invalid-feedback">
                                    {{ getFieldError('phone1') }}
                                </div>
                            </div>

                                <!-- Phone 2 -->
                                <div class="col-md-6">
                                    <label for="phone2" class="form-label">Secondary Phone</label>
                                    <input 
                                        id="phone2" 
                                        type="tel" 
                                        class="form-control" 
                                        formControlName="phone2"
                                        placeholder="+27987654321">
                                </div>
                            </div>

                            <!-- Address -->
                            <div class="row g-3 mt-3">
                                <div class="col-12">
                                    <label for="address" class="form-label">Physical Address *</label>
                                    <input 
                                        id="address" 
                                        type="text" 
                                        class="form-control" 
                                        formControlName="address"
                                        [class.is-invalid]="isFieldInvalid('address')"
                                        placeholder="123 Main Street, City, Province, 0000">
                                    <div *ngIf="isFieldInvalid('address')" class="invalid-feedback">
                                        {{ getFieldError('address') }}
                                    </div>
                                </div>
                            </div>

                            <!-- Terms and Conditions -->
                            <div class="row g-3 mt-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input 
                                        type="checkbox"
                                        class="form-check-input"
                                        formControlName="agreeToTerms"
                                        id="agreeToTerms">
                                    <label for="agreeToTerms" class="form-check-label">
                                        I agree to the <a href="/terms" target="_blank">Terms and Conditions</a> and <a href="/privacy" target="_blank">Privacy Policy</a> *
                                    </label>
                                </div>
                                <div *ngIf="isFieldInvalid('agreeToTerms')" class="invalid-feedback d-block">
                                    You must agree to the terms and conditions
                                </div>
                                </div>
                                </div>
                            </div>
                        </form>
                    </div>

                <!-- Step 2: Plan Selection -->
                <div *ngIf="activeIndex() === 1" class="step-content">
                    <h3>Choose Your Subscription Plan</h3>
                    
                    <div *ngIf="wizardLoading()" class="loading-container">
                        <div class="spinner-border" role="status"></div>
                    </div>

                    <div *ngIf="!wizardLoading()" class="plans-grid">
                        <div *ngFor="let plan of plans()" 
                             class="plan-card" 
                             [class.selected]="selectedPlan()?.id === plan.id"
                             (click)="selectPlan(plan)">
                            <div class="plan-header">
                                <h4>{{ plan.name }}</h4>
                                <p class="plan-description">{{ plan.description }}</p>
                            </div>
                            <div class="plan-price">
                                <div class="price-row">
                                    <span class="currency">R</span>
                                    <span class="amount">{{ plan.monthlyPrice | number:'1.2-2' }}</span>
                                    <span class="period">/month</span>
                                </div>
                                <div class="price-row" *ngIf="plan.yearlyPrice && plan.yearlyPrice > 0">
                                    <span class="currency">R</span>
                                    <span class="amount">{{ plan.yearlyPrice | number:'1.2-2' }}</span>
                                    <span class="period">/year</span>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="plan-features">
                                <div class="feature" *ngIf="plan.supportsIdentityVerification">
                                    <i class="bi bi-check-lg"></i>
                                    <span>Identity Verification</span>
                                </div>
                                <div class="feature" *ngIf="plan.maxVerificationsPerMonth > 0">
                                    <i class="bi bi-check-lg"></i>
                                    <span>{{ plan.maxVerificationsPerMonth }} verifications/month</span>
                                </div>
                                <div class="feature" *ngIf="plan.enhancedVerification">
                                    <i class="bi bi-check-lg"></i>
                                    <span>Enhanced Verification</span>
                                </div>
                                <div class="feature" *ngIf="plan.quickIdCheck">
                                    <i class="bi bi-check-lg"></i>
                                    <span>Quick ID Check</span>
                                </div>
                                <div class="feature" *ngIf="plan.bulkVerification">
                                    <i class="bi bi-check-lg"></i>
                                    <span>Bulk Verification</span>
                                </div>
                                <div class="feature" *ngIf="plan.verificationHistory">
                                    <i class="bi bi-check-lg"></i>
                                    <span>Verification History</span>
                                </div>
                            </div>
                            <button 
                                [label]="selectedPlan()?.id === plan.id ? 'Selected' : 'Select Plan'"
                                [class]="selectedPlan()?.id === plan.id ? 'btn-success' : 'btn-outlined'"
                                [icon]="selectedPlan()?.id === plan.id ? 'bi bi-check-lg' : ''"
                                class="select-plan-btn">
                            </button>
                        </div>
                    </div>

                    <!-- Coupon Code Section -->
                    <div *ngIf="selectedPlan()" class="coupon-section mt-4">
                        <h4 class="mb-3">Have a coupon code?</h4>
                        <div class="input-group">
                            <input 
                                type="text" 
                                class="form-control" 
                                [(ngModel)]="couponCode"
                                placeholder="Enter coupon code"
                                [disabled]="couponLoading()">
                            <button 
                                type="button"
                                class="btn btn-primary"
                                [disabled]="!couponCode() || couponLoading()"
                                (click)="validateCoupon()">
                                <span *ngIf="couponLoading()" class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Apply
                            </button>
                        </div>
                        
                        <div *ngIf="couponValidation()?.isValid" class="alert alert-success mt-3 d-flex align-items-center" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span>{{ couponValidation()?.message }}</span>
                        </div>
                    </div>

                    <!-- Billing cycle selection -->
                    <div *ngIf="selectedPlan()" class="billing-cycle-section" style="margin-top:1rem;">
                        <label class="billing-label">Billing frequency:</label>
                        <div style="display:flex; gap:1rem; margin-top:0.5rem;">
                            <label><input type="radio" name="billingCycle" [value]="0" [(ngModel)]="billingCycle" (change)="onBillingCycleChange()"> Monthly</label>
                            <label><input type="radio" name="billingCycle" [value]="1" [(ngModel)]="billingCycle" (change)="onBillingCycleChange()"> Yearly</label>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div *ngIf="selectedPlan()" class="price-summary">
                        <div class="summary-row">
                            <span>Plan:</span>
                            <span *ngIf="billingCycle === 0">R {{ selectedPlan()?.monthlyPrice | number:'1.2-2' }}/month</span>
                            <span *ngIf="billingCycle === 1">R {{ selectedPlan()?.yearlyPrice | number:'1.2-2' }}/year</span>
                        </div>
                        <div *ngIf="getDiscountAmount() > 0" class="summary-row discount">
                            <span>Discount:</span>
                            <span>-R {{ getDiscountAmount() | number:'1.2-2' }}</span>
                        </div>
                        <hr class="my-3">
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span *ngIf="billingCycle === 0">R {{ getFinalPrice() | number:'1.2-2' }}/month</span>
                            <span *ngIf="billingCycle === 1">R {{ getFinalPrice() | number:'1.2-2' }}/year</span>
                        </div>
                    </div>
                </div>

                    <!-- Step 3: Payment Processing -->
                    <div *ngIf="activeIndex() === 2" class="step-content">
                    <div class="payment-processing">
                        <div class="spinner-border" role="status"></div>
                        <h3>Processing Payment...</h3>
                        <p>Please wait while we redirect you to the payment gateway.</p>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <div class="wizard-actions">
                    <button 
                        label="Back"
                        icon="pi pi-arrow-left"
                        class="btn-text"
                        [disabled]="activeIndex() === 0 || wizardLoading()"
                        (click)="previousStep()">
                    </button>
                    
                    <div class="right-actions">
                        <a routerLink="/auth/login" class="btn btn-link">
                            Already have an account? Login
                        </a>
                        
                        <button 
                            type="button"
                            class="btn btn-primary"
                            [disabled]="wizardLoading()"
                            (click)="nextStep()">
                            <span *ngIf="!wizardLoading()">{{ activeIndex() === 1 ? 'Proceed to Payment' : 'Continue' }}</span>
                            <span *ngIf="wizardLoading()" class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <i class="bi bi-arrow-right ms-2" *ngIf="!wizardLoading()"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
