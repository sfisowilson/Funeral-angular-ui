<div class="grid">
    <div class="col-12">
        <div class="card"><div class="card-header" *ngIf="''"></div><div class="card-body">
            <ng-template pTemplate="header">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h3 class="m-0">Subscription Management</h3>
                    </ng-template>
                    <div>
                        <p-button 
                            label="Process Renewals" 
                            icon="pi pi-refresh"
                            styleClass="btn-outlined"
                            (click)="processRenewals()">
                        
                    </ng-template>
                </ng-template>

            <!-- Filters -->
            <div class="grid mb-3">
                <div class="col-12 md:col-4">
                    <span class="p-input-icon-left w-full">
                        <i class="bi bi-search"></i>
                        <input 
                            type="text" 
                            class="form-control" 
                            [(ngModel)]="searchText"
                            placeholder="Search by tenant name..."
                            class="w-full"
                            (keyup.enter)="applyFilters()" />
                    </span>
                </div>
                <div class="col-12 md:col-3">
                    <select class="form-select" [(ngModel)]="statusFilter">
    <option [ngValue]="undefined">Filter by status</option>
    <option *ngFor="let item of statusOptions" [ngValue]="item.value">{{ item.label }}</option>
</select>
                    
                </div>
                <div class="col-12 md:col-3">
                    <select class="form-select" [(ngModel)]="planFilter">
    <option [ngValue]="undefined">Filter by plan</option>
    <option *ngFor="let item of plans()" [ngValue]="item.id">{{ item.name }}</option>
</select>
                    
                </div>
                <div class="col-12 md:col-2 flex gap-2">
                    <p-button 
                        label="Apply" 
                        icon="bi bi-check-lg"
                        styleClass="btn-sm"
                        (click)="applyFilters()">
                    
                    <p-button 
                        label="Clear" 
                        icon="bi bi-x-lg"
                        styleClass="btn-sm btn-outlined"
                        (click)="clearFilters()">
                    
                </div>
            </div>

            <!-- Subscriptions Table -->
            <div class="table-responsive"><table class="table table-hover table-striped">
                
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="tenantName">
                            Tenant <p-sortIcon field="tenantName"></p-sortIcon>
                        </th>
                        <th pSortableColumn="subscriptionPlan.name">
                            Plan <p-sortIcon field="subscriptionPlan.name"></p-sortIcon>
                        </th>
                        <th pSortableColumn="amount">
                            Amount <p-sortIcon field="amount"></p-sortIcon>
                        </th>
                        <th pSortableColumn="status">
                            Status <p-sortIcon field="status"></p-sortIcon>
                        </th>
                        <th>Current Period</th>
                        <th>Days Remaining</th>
                        <th>Actions</th>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-subscription>
                    <tr>
                        <td>{{ subscription.tenantName || 'N/A' }}</td>
                        <td>
                            <div class="font-semibold">{{ subscription.subscriptionPlan?.name }}</div>
                            <small class="text-color-secondary">{{ subscription.subscriptionPlan?.description }}</small>
                        </td>
                        <td>{{ formatCurrency(subscription.amount) }}</td>
                        <td>
                            <span class="badge" [ngClass]="'bg-' + getStatusSeverity(subscription.status)">{{ subscription.status }}</span>
                            
                        </td>
                        <td>
                            <div class="text-sm">
                                <div>Start: {{ formatDate(subscription.currentPeriodStart) }}</div>
                                <div>End: {{ formatDate(subscription.currentPeriodEnd) }}</div>
                            </div>
                        </td>
                        <td>
                            <span class="font-semibold">{{ getDaysRemaining(subscription.currentPeriodEnd) }} days</span>
                        </td>
                        <td>
                            <div class="flex gap-1 flex-wrap">
                                <p-button 
                                    icon="pi pi-ban" 
                                    styleClass="btn-text btn-sm btn-warning"
                                    [pTooltip]="'Suspend'"
                                    (click)="suspendSubscription(subscription)"
                                    [disabled]="subscription.status !== 'Active'">
                                
                                <p-button 
                                    icon="bi bi-check-lg-circle" 
                                    styleClass="btn-text btn-sm btn-success"
                                    [pTooltip]="'Reactivate'"
                                    (click)="reactivateSubscription(subscription)"
                                    [disabled]="subscription.status !== 'Suspended'">
                                
                                <p-button 
                                    icon="pi pi-arrow-right-arrow-left" 
                                    styleClass="btn-text btn-sm"
                                    [pTooltip]="'Change Plan'"
                                    (click)="openChangePlanDialog(subscription)">
                                
                            </div>
                        </td>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center p-5">
                            <i class="pi pi-info-circle text-4xl text-color-secondary mb-3"></i>
                            <p class="text-color-secondary m-0">No subscriptions found.</p>
                        </td>
                    </tr>
                </ng-template>
            </table></div>
        </div></div>
    </div>
</div>

<!-- Change Plan Dialog -->
<p-dialog 
    [(visible)]="showChangePlanDialog" 
    header="Change Subscription Plan" 
    [modal]="true"
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false">
    
    <div class="flex flex-column gap-3" *ngIf="selectedSubscription">
        <p>Change the subscription plan for this tenant.</p>
        
        <div class="field">
            <label for="newPlan" class="font-semibold">New Plan</label>
            <p-dropdown 
                id="newPlan"
                [(ngModel)]="newPlanId"
                [options]="plans()"
                optionLabel="name"
                optionValue="id"
                placeholder="Select new plan"
                class="w-full"
                [disabled]="changingPlan">
                <ng-template let-plan pTemplate="item">
                    <div>
                        <div class="font-semibold">{{ plan.name }}</div>
                        <div class="text-sm text-color-secondary">{{ formatCurrency(plan.price) }}/month</div>
                    </ng-template>
            
        </div>

        <p-messages class="text-info">
            <ng-template pTemplate="content">
                The plan change will take effect at the end of the current billing period.
            </ng-template>
        
    </div>
    
    <ng-template pTemplate="footer">
        <p-button 
            label="Cancel" 
            icon="bi bi-x-lg" 
            styleClass="btn-text"
            (click)="showChangePlanDialog = false"
            [disabled]="changingPlan">
        
        <p-button 
            label="Change Plan" 
            icon="bi bi-check-lg"
            (click)="changePlan()"
            [loading]="changingPlan"
            [disabled]="!newPlanId || newPlanId === selectedSubscription?.subscriptionPlanId?.toString()">
        
    </ng-template>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade" [class.show]="$1" *ngIf="$1"></div>

<!-- Toast replaced with custom alert system -->
<!-- ConfirmDialog replaced with custom confirmation system --></p-confirmDialog>
