<p-toast position="top-right"></p-toast>

<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button class="btn-primary-theme me-2" (click)="openNew()">
                <i class="bi bi-plus-lg"></i> New
            </button>
            <button class="btn-secondary-theme" (click)="exportCSV()">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th style="width: 10%">Code</th>
                    <th style="width: 12%">Name</th>
                    <th style="width: 15%">Description</th>
                    <th style="width: 8%">Type</th>
                    <th style="width: 8%">Discount</th>
                    <th style="width: 10%">Duration</th>
                    <th style="width: 12%">Tenant Types</th>
                    <th style="width: 8%">Redeemed</th>
                    <th style="width: 10%">Expires</th>
                    <th style="width: 7%">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let coupon of coupons()">
                    <td><span class="fw-bold">{{ coupon.code }}</span></td>
                    <td>{{ coupon.name }}</td>
                    <td>{{ coupon.description }}</td>
                    <td>{{ coupon.discountType === 'Percentage' ? '%' : 'Fixed' }}</td>
                    <td>
                        <span *ngIf="coupon.discountType === 'Percentage'">{{ coupon.discountValue }}%</span>
                        <span *ngIf="coupon.discountType === 'FixedAmount'">R {{ coupon.discountValue | number: '1.2-2' }}</span>
                    </td>
                    <td>
                        <span class="badge" [class.bg-success]="coupon.durationInMonths === 1" [class.bg-info]="coupon.durationInMonths > 1">
                            {{ coupon.durationInMonths }}{{ coupon.durationInMonths === 1 ? ' mo' : ' mos' }}
                        </span>
                    </td>
                    <td>
                        <span *ngIf="!coupon.applicableTenantTypes || coupon.applicableTenantTypes.length === 0" class="badge bg-secondary">All</span>
                        <span *ngFor="let type of coupon.applicableTenantTypes" class="badge bg-primary me-1">{{ type }}</span>
                    </td>
                    <td>{{ coupon.currentRedemptions }}<span *ngIf="coupon.maxRedemptions"> / {{ coupon.maxRedemptions }}</span></td>
                    <td>
                        <span *ngIf="coupon.validUntil">{{ coupon.validUntil | date: 'short' }}</span>
                        <span *ngIf="!coupon.validUntil" class="text-secondary">Never</span>
                    </td>
                    <td>
                        <i class="bi" [ngClass]="{ 'bi-check-circle text-success': coupon.isActive, 'bi-x-circle text-danger': !coupon.isActive }"></i>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" (click)="editCoupon(coupon)">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" (click)="deleteCoupon(coupon)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal" [class.show]="couponDialog" [style.display]="couponDialog ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Coupon Details</h5>
                <button type="button" class="btn-close" (click)="hideDialog()"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="code" class="form-label">Code *</label>
                        <input type="text" class="form-control" id="code" [(ngModel)]="coupon.code" [disabled]="coupon.id" placeholder="e.g., SAVE20" />
                    </div>

                    <div class="col-md-6">
                        <label for="name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="name" [(ngModel)]="coupon.name" placeholder="e.g., Save 20%" />
                    </div>

                    <div class="col-12">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" [(ngModel)]="coupon.description" rows="3" placeholder="Coupon description..."></textarea>
                    </div>

                    <div class="col-md-6">
                        <label for="discountType" class="form-label">Discount Type *</label>
                        <select class="form-select" id="discountType" [(ngModel)]="coupon.discountType">
                            <option value="">Select type</option>
                            <option *ngFor="let type of discountTypes" [value]="type.value">{{ type.label }}</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="discountValue" class="form-label">Discount Value *</label>
                        <input type="number" class="form-control" id="discountValue" [(ngModel)]="coupon.discountValue" placeholder="0.00" />
                    </div>

                    <div class="col-md-6">
                        <label for="validFrom" class="form-label">Valid From *</label>
                        <input type="date" class="form-control" id="validFrom" [(ngModel)]="coupon.validFrom" />
                    </div>

                    <div class="col-md-6">
                        <label for="validUntil" class="form-label">Valid Until</label>
                        <input type="date" class="form-control" id="validUntil" [(ngModel)]="coupon.validUntil" />
                    </div>

                    <div class="col-md-6">
                        <label for="durationInMonths" class="form-label">Duration (Billing Cycles) *</label>
                        <input type="number" class="form-control" id="durationInMonths" [(ngModel)]="coupon.durationInMonths" min="1" />
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i>
                            <span *ngIf="coupon.durationInMonths === 1">One-time discount (first billing cycle only)</span>
                            <span *ngIf="coupon.durationInMonths > 1">Recurring discount for {{ coupon.durationInMonths }} billing cycles (auto-applied)</span>
                        </small>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Applicable to Tenant Types</label>
                        <div class="form-text mb-2"><i class="bi bi-info-circle"></i> Select specific organization types, or leave empty for all types</div>
                        <div class="row">
                            <div class="col-md-3" *ngFor="let type of tenantTypes">
                                <div class="form-check">
                                    <input 
                                        type="checkbox" 
                                        class="form-check-input" 
                                        [id]="'tenantType_' + type.value"
                                        [value]="type.value"
                                        [checked]="coupon.applicableTenantTypes?.includes(type.value)"
                                        (change)="onTenantTypeChange(type.value, $event)">
                                    <label class="form-check-label" [for]="'tenantType_' + type.value">
                                        {{ type.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <span *ngIf="!coupon.applicableTenantTypes || coupon.applicableTenantTypes.length === 0" class="badge bg-secondary">Currently applies to ALL tenant types</span>
                            <span *ngIf="coupon.applicableTenantTypes && coupon.applicableTenantTypes.length > 0" class="badge bg-primary">Restricted to {{ coupon.applicableTenantTypes.length }} type(s)</span>
                        </small>
                    </div>

                    <div class="col-md-6">
                        <label for="maxRedemptions" class="form-label">Max Redemptions</label>
                        <input type="number" class="form-control" id="maxRedemptions" [(ngModel)]="coupon.maxRedemptions" min="1" placeholder="Unlimited if empty" />
                    </div>

                    <div class="col-md-6">
                        <label for="minimumPurchase" class="form-label">Minimum Purchase Amount</label>
                        <input type="number" class="form-control" id="minimumPurchase" [(ngModel)]="coupon.minimumPurchaseAmount" placeholder="0.00" />
                    </div>

                    <div class="col-md-6">
                        <label for="campaignName" class="form-label">Campaign Name</label>
                        <input type="text" class="form-control" id="campaignName" [(ngModel)]="coupon.campaignName" placeholder="e.g., BlackFriday2024" />
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isFirstTimeOnly" [(ngModel)]="coupon.isFirstTimeOnly">
                            <label class="form-check-label" for="isFirstTimeOnly">First Time Use Only</label>
                        </div>
                    </div>

                    <div class="col-12" *ngIf="coupon.id">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" [(ngModel)]="coupon.isActive">
                            <label class="form-check-label" for="isActive">Active</label>
                        </div>
                    </div>

                    <div class="col-12">
                        <label for="internalNotes" class="form-label">Internal Notes</label>
                        <textarea class="form-control" id="internalNotes" [(ngModel)]="coupon.internalNotes" rows="2" placeholder="Notes for team use only..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary-theme" (click)="hideDialog()">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
                <button type="button" class="btn-primary-theme" (click)="saveCoupon()">
                    <i class="bi bi-check-lg"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade" [class.show]="couponDialog" *ngIf="couponDialog"></div>
