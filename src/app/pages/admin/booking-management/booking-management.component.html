<div class="surface-section">
    <!-- Header -->
    <div class="flex justify-content-between align-items-center mb-4">
        <h1 class="text-2xl font-bold">Booking Management</h1>
        <div class="flex gap-2">
            <button 
                type="button" 
                class="btn-outline-primary-theme" 
                (click)="openConfigDialog()">
                <i class="pi pi-cog me-2"></i>
                Configure Widget
            </button>
            <button 
                type="button" 
                class="btn-primary-theme" 
                (click)="exportBookings()">
                <i class="pi pi-download me-2"></i>
                Export CSV
            </button>
        </div>
    </div>

    <!-- Filters Toolbar -->
    <p-toolbar styleClass="mb-4">
        <ng-template #start>
            <div class="flex align-items-center gap-3">
                <div class="flex align-items-center gap-2">
                    <label for="dateRange" class="font-bold">Date Range:</label>
                    <p-calendar 
                        id="dateRange"
                        [(ngModel)]="dateRange" 
                        selectionMode="range" 
                        [readonlyInput]="true"
                        [showIcon]="true"
                        placeholder="Select date range"
                        (onChange)="applyFilters()">
                    </p-calendar>
                </div>

                <div class="flex align-items-center gap-2">
                    <label for="statusFilter" class="font-bold">Status:</label>
                    <p-dropdown 
                        id="statusFilter"
                        [options]="statusOptions" 
                        [(ngModel)]="selectedStatus"
                        optionLabel="label" 
                        optionValue="value"
                        placeholder="All Status"
                        (onChange)="applyFilters()"
                        [style]="{'width': '150px'}">
                    </p-dropdown>
                </div>

                <div class="flex align-items-center gap-2">
                    <label for="globalFilter" class="font-bold">Search:</label>
                    <input 
                        type="text" 
                        id="globalFilter"
                        class="form-control"
                        [(ngModel)]="globalFilter"
                        (input)="applyFilters()"
                        placeholder="Search bookings...">
                </div>
            </div>
        </ng-template>

        <ng-template #end>
            <div class="text-muted">
                {{filteredBookings().length}} bookings found
            </div>
        </ng-template>
    </p-toolbar>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="text-center p-8">
        <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>
        <p class="mt-3 text-muted">Loading bookings...</p>
    </div>

    <!-- Bookings Table -->
    <div *ngIf="!isLoading()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div 
            *ngFor="let booking of filteredBookings()" 
            class="booking-card border-round border-1 surface-card p-4">
            
            <!-- Booking Header -->
            <div class="flex justify-content-between align-items-start mb-3">
                <div>
                    <h4 class="text-lg font-semibold mb-1">{{booking.customerName}}</h4>
                    <p class="text-muted text-sm mb-0">{{booking.customerEmail}}</p>
                    <p *ngIf="booking.customerPhone" class="text-muted text-sm mb-0">{{booking.customerPhone}}</p>
                </div>
                <p-tag 
                    [value]="booking.status" 
                    [severity]="getStatusSeverity(booking.status)"
                    class="text-uppercase">
                </p-tag>
            </div>

            <!-- Booking Details -->
            <div class="mb-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-calendar text-primary"></i>
                    <span>{{booking.bookingDate | date:'longDate'}}</span>
                </div>
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-clock text-primary"></i>
                    <span>{{booking.timeSlot.time}}</span>
                </div>
            </div>

            <!-- Services -->
            <div class="mb-3">
                <h5 class="font-semibold mb-2">Services:</h5>
                <ul class="list-none p-0 m-0">
                    <li *ngFor="let service of booking.services" class="mb-1">
                        <div class="flex justify-content-between">
                            <span>{{service.name}}</span>
                            <span class="text-muted">${{service.price || 0}}</span>
                        </div>
                    </li>
                </ul>
                <div class="border-top pt-2 mt-2">
                    <div class="flex justify-content-between font-semibold">
                        <span>Total:</span>
                        <span>{{getTotalServicesPrice(booking.services) | currency:'USD'}}</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div *ngIf="booking.customerNotes" class="mb-3">
                <h5 class="font-semibold mb-2">Notes:</h5>
                <p class="text-muted text-sm">{{booking.customerNotes}}</p>
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
                <button 
                    type="button" 
                    class="btn-outline-primary-theme flex-1"
                    (click)="viewBookingDetails(booking)">
                    <i class="pi pi-eye me-2"></i>
                    View
                </button>
                
                <button 
                    *ngIf="booking.status === 'pending'"
                    type="button" 
                    class="btn-primary-theme flex-1"
                    (click)="confirmBooking(booking)">
                    <i class="pi pi-check me-2"></i>
                    Confirm
                </button>
                
                <button 
                    *ngIf="booking.status !== 'cancelled'"
                    type="button" 
                    class="btn-warning-theme flex-1"
                    (click)="cancelBooking(booking)">
                    <i class="pi pi-times me-2"></i>
                    Cancel
                </button>
                
                <button 
                    type="button" 
                    class="btn-danger-theme"
                    (click)="deleteBooking(booking)">
                    <i class="pi pi-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading() && filteredBookings().length === 0" class="text-center p-8">
        <i class="pi pi-calendar-times text-4xl text-500 mb-3"></i>
        <p class="text-500 text-lg mb-2">No bookings found</p>
        <p class="text-400">Try adjusting your filters or date range</p>
    </div>
</div>

<!-- Booking Details Dialog -->
<p-dialog 
    [visible]="showBookingDialog()" 
    (visibleChange)="showBookingDialog.set($event)"
    [style]="{ width: '600px' }" 
    [header]="'Booking Details - ' + (selectedBooking?.customerName || '')" 
    [modal]="true"
    [dismissableMask]="true">
    
    <ng-template #content>
        <div *ngIf="selectedBooking" class="flex flex-col gap-4">
            <!-- Customer Information -->
            <div>
                <h4 class="font-semibold mb-2">Customer Information</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <strong>Name:</strong> {{selectedBooking.customerName}}
                    </div>
                    <div>
                        <strong>Email:</strong> {{selectedBooking.customerEmail}}
                    </div>
                    <div *ngIf="selectedBooking.customerPhone">
                        <strong>Phone:</strong> {{selectedBooking.customerPhone}}
                    </div>
                    <div>
                        <strong>Status:</strong>
                        <p-tag 
                            [value]="selectedBooking.status" 
                            [severity]="getStatusSeverity(selectedBooking.status)"
                            class="ml-2">
                        </p-tag>
                    </div>
                </div>
            </div>

            <!-- Booking Information -->
            <div>
                <h4 class="font-semibold mb-2">Booking Information</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <strong>Date:</strong> {{selectedBooking.bookingDate | date:'longDate'}}
                    </div>
                    <div>
                        <strong>Time:</strong> {{selectedBooking.timeSlot.time}}
                    </div>
                    <div>
                        <strong>Created:</strong> {{selectedBooking.createdAt | date:'long'}}
                    </div>
                    <div>
                        <strong>Updated:</strong> {{selectedBooking.updatedAt | date:'long'}}
                    </div>
                </div>
            </div>

            <!-- Services -->
            <div>
                <h4 class="font-semibold mb-2">Services</h4>
                <ul class="list-none p-0 m-0">
                    <li *ngFor="let service of selectedBooking.services" class="mb-2 p-3 border-round border-1 surface-100">
                        <div class="flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">{{service.name}}</h5>
                                <p class="text-muted text-sm mb-0">{{service.description}}</p>
                            </div>
                            <div class="text-right">
                                <strong>${{service.price || 0}}</strong>
                                <div class="text-muted small">{{service.duration || 30}} min</div>
                            </div>
                        </div>
                    </li>
                </ul>
                <div class="border-top pt-3 mt-3">
                    <div class="flex justify-content-between font-semibold text-lg">
                        <span>Total:</span>
                        <span>{{getTotalServicesPrice(selectedBooking.services) | currency:'USD'}}</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div *ngIf="selectedBooking.customerNotes">
                <h4 class="font-semibold mb-2">Customer Notes</h4>
                <div class="p-3 border-round border-1 surface-100">
                    {{selectedBooking.customerNotes}}
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <button 
            type="button" 
            class="btn-secondary-theme" 
            (click)="showBookingDialog.set(false)">
            Close
        </button>
    </ng-template>
</p-dialog>

<!-- Configuration Dialog -->
<p-dialog 
    [visible]="showConfigDialog()" 
    (visibleChange)="showConfigDialog.set($event)"
    [style]="{ width: '800px' }" 
    header="Booking Widget Configuration" 
    [modal]="true"
    [dismissableMask]="true">
    
    <ng-template #content>
        <div *ngIf="bookingConfig()" class="flex flex-col gap-4">
            <!-- Display Settings -->
            <div class="config-section">
                <h4 class="font-semibold mb-3">Display Settings</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex align-items-center">
                        <p-checkbox 
                            [(ngModel)]="bookingConfig()!.showInDashboard" 
                            inputId="showInDashboard"
                            binary="true">
                        </p-checkbox>
                        <label for="showInDashboard" class="ml-2">Show in Dashboard</label>
                    </div>
                    <div class="flex align-items-center">
                        <p-checkbox 
                            [(ngModel)]="bookingConfig()!.showOnLandingPage" 
                            inputId="showOnLandingPage"
                            binary="true">
                        </p-checkbox>
                        <label for="showOnLandingPage" class="ml-2">Show on Landing Page</label>
                    </div>
                    <div class="flex align-items-center">
                        <p-checkbox 
                            [(ngModel)]="bookingConfig()!.requireEmail" 
                            inputId="requireEmail"
                            binary="true">
                        </p-checkbox>
                        <label for="requireEmail" class="ml-2">Require Email</label>
                    </div>
                    <div class="flex align-items-center">
                        <p-checkbox 
                            [(ngModel)]="bookingConfig()!.requirePhone" 
                            inputId="requirePhone"
                            binary="true">
                        </p-checkbox>
                        <label for="requirePhone" class="ml-2">Require Phone</label>
                    </div>
                </div>
            </div>

            <!-- Booking Rules -->
            <div class="config-section">
                <h4 class="font-semibold mb-3">Booking Rules</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-column">
                        <label for="bookingLeadTime" class="font-bold mb-2">Booking Lead Time (hours)</label>
                        <input 
                            type="number" 
                            id="bookingLeadTime"
                            class="form-control"
                            [(ngModel)]="bookingConfig()!.bookingLeadTime"
                            min="0"
                            max="168">
                    </div>
                    <div class="flex flex-column">
                        <label for="maxBookingDuration" class="font-bold mb-2">Max Booking Duration (hours)</label>
                        <input 
                            type="number" 
                            id="maxBookingDuration"
                            class="form-control"
                            [(ngModel)]="bookingConfig()!.maxBookingDuration"
                            min="1"
                            max="12">
                    </div>
                </div>
            </div>

            <!-- Working Hours -->
            <div class="config-section">
                <h4 class="font-semibold mb-3">Working Hours</h4>
                <div class="working-hours-grid">
                    <div *ngFor="let day of daysOfWeek; let i = index" class="day-config">
                        <h5 class="font-semibold mb-2 text-capitalize">{{day}}</h5>
                        <div class="flex flex-column gap-2">
                            <div class="flex align-items-center">
                                <p-checkbox 
                                    [(ngModel)]="bookingConfig()!.workingHours[day].closed" 
                                    inputId="{{day + '-closed'}}"
                                    binary="true">
                                </p-checkbox>
                                <label [for]="day + '-closed'" class="ml-2">Closed</label>
                            </div>
                            <div *ngIf="!bookingConfig()!.workingHours[day].closed" class="flex gap-2">
                                <input 
                                    type="time" 
                                    class="form-control"
                                    [(ngModel)]="bookingConfig()!.workingHours[day].start"
                                    [disabled]="bookingConfig()!.workingHours[day].closed">
                                <input 
                                    type="time" 
                                    class="form-control"
                                    [(ngModel)]="bookingConfig()!.workingHours[day].end"
                                    [disabled]="bookingConfig()!.workingHours[day].closed">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <button 
            type="button" 
            class="btn-secondary-theme" 
            (click)="showConfigDialog.set(false)">
            Cancel
        </button>
        <button 
            type="button" 
            class="btn-primary-theme" 
            (click)="saveBookingConfig()">
            <i class="pi pi-save me-2"></i>
            Save Configuration
        </button>
    </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmdialog [style]="{ width: '450px' }" />
