<div class="card">
    <h5>User Profile</h5>

    <div class="user-profile-container">
        <h2>My Profile</h2>

        <!-- Authentication Status -->
        <div class="auth-status" [ngClass]="{ authenticated: authService.isAuthenticated(), 'not-authenticated': !authService.isAuthenticated() }">
            <p><strong>Authentication Status:</strong> {{ authService.isAuthenticated() ? 'Authenticated' : 'Not Authenticated' }}</p>
            <p *ngIf="authService.getToken()"><strong>Token Present:</strong> Yes</p>
            <p *ngIf="!authService.getToken()"><strong>Token Present:</strong> No</p>
            <p *ngIf="authService.decodeToken()"><strong>User ID:</strong> {{ authService.decodeToken().sub || 'N/A' }}</p>
        </div>

        <div *ngIf="!authService.isAuthenticated()" class="not-authenticated-message">
            <h3>Authentication Required</h3>
            <p>You must be logged in to view your profile.</p>

            <!-- TEMPORARY LOGIN FORM FOR DEBUGGING -->
            <div class="debug-login-form" style="margin: 20px 0; padding: 20px; border: 2px solid #007bff; border-radius: 8px; background-color: #f8f9fa">
                <h4>üîß Debug Login Form</h4>
                <p><em>Temporary form for testing authentication</em></p>

                <div class="form-group" style="margin-bottom: 15px">
                    <label for="debugEmail">Email:</label>
                    <input pInputText id="debugEmail" [(ngModel)]="debugLoginForm.email" placeholder="Enter email address" style="width: 100%; margin-top: 5px" />
                </div>

                <div class="form-group" style="margin-bottom: 15px">
                    <label for="debugPassword">Password:</label>
                    <input pInputText type="password" id="debugPassword" [(ngModel)]="debugLoginForm.password" placeholder="Enter password" style="width: 100%; margin-top: 5px" />
                </div>

                <button pButton type="button" label="Debug Login" (click)="debugLogin()" [disabled]="debugLoginInProgress" style="margin-right: 10px"></button>

                <p *ngIf="debugLoginInProgress" style="color: #007bff; margin-top: 10px">üîÑ Attempting login...</p>

                <p *ngIf="debugLoginMessage" style="margin-top: 10px" [ngStyle]="{ color: debugLoginSuccess ? '#28a745' : '#dc3545' }">
                    {{ debugLoginMessage }}
                </p>
            </div>

            <p><a href="/auth/login" class="login-link">Click here to go to the main login page</a></p>
            <p><em>Or use the navigation menu to go to the login page.</em></p>
        </div>

        <div *ngIf="authService.isAuthenticated() && !authService.hasPermission('Permission.UserProfile.View')" class="permission-denied-message">
            <h3>Access Denied</h3>
            <p>You don't have permission to view your profile.</p>
            <p><strong>Required Permission:</strong> Permission.UserProfile.View</p>
            <p><strong>Your Permissions:</strong></p>
            <ul>
                <li *ngFor="let permission of authService.getPermissions()">{{ permission }}</li>
            </ul>
            <p *ngIf="authService.getPermissions().length === 0"><em>No permissions assigned</em></p>
            <p><strong>Your Roles:</strong></p>
            <ul>
                <li *ngFor="let role of authService.getRoles()">{{ role }}</li>
            </ul>
            <p *ngIf="authService.getRoles().length === 0"><em>No roles assigned</em></p>
        </div>

        <div *ngIf="isLoading" class="loading-section">
            <p>Loading profile...</p>
        </div>

        <div *ngIf="!isLoading && authService.isAuthenticated()" class="profile-form">
            <!-- PERMISSION CHECK TEMPORARILY COMMENTED OUT FOR DEBUGGING -->
            <!-- && authService.hasPermission('Permission.UserProfile.View') -->
            <div class="form-group">
                <label for="firstName">First Name *</label>
                <input pInputText id="firstName" [(ngModel)]="updateUserProfileDto.firstName" placeholder="Enter first name" required />
            </div>

            <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input pInputText id="lastName" [(ngModel)]="updateUserProfileDto.lastName" placeholder="Enter last name" required />
            </div>

            <div class="form-group">
                <label for="emailAddress">Email Address</label>
                <input pInputText id="emailAddress" [value]="userProfile.emailAddress" placeholder="Email address" readonly />
            </div>

            <div class="form-group">
                <label for="phoneNumber">Phone Number</label>
                <input pInputText id="phoneNumber" [(ngModel)]="updateUserProfileDto.phoneNumber" placeholder="Enter phone number" />
            </div>

            <div class="form-group">
                <label for="address">Address</label>
                <textarea pInputTextarea id="address" [(ngModel)]="updateUserProfileDto.address" placeholder="Enter address" rows="3"> </textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" (click)="updateProfile()" [disabled]="isLoading || !isFormValid()">
                    Update Profile
                </button>

                <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="isLoading">
                    Reset
                </button>
            </div>

            <!-- Debug Information -->
            <div class="debug-info">
                <h3>Debug Information</h3>
                <p>User ID: {{ userProfile.id || 'Not loaded' }}</p>
                <p>Email: {{ userProfile.emailAddress || 'Not loaded' }}</p>
                <p>Loading: {{ isLoading }}</p>
                <p>Form Valid: {{ isFormValid() }}</p>

                <!-- Team Component Test -->
                <div style="margin-top: 20px; padding: 15px; border: 2px solid #28a745; border-radius: 8px; background-color: #f8fff8">
                    <h4>üè¢ Team Component Test</h4>
                    <button pButton type="button" label="Test Team Component" (click)="testTeamComponent()" style="margin-bottom: 10px"></button>

                    <div *ngIf="showTeamTest" style="border: 1px solid #ddd; padding: 10px; margin-top: 10px">
                        <app-team-editor-widget [config]="testTeamConfig"></app-team-editor-widget>
                    </div>

                    <p *ngIf="teamTestMessage" style="color: #007bff; margin-top: 10px">
                        {{ teamTestMessage }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
