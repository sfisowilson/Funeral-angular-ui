<div class="grid">
    <div class="col-12">
        <div class="card">
            <h5>Tenant Registration Approvals</h5>
            <p-table 
                [value]="tenants()" 
                [loading]="loading()"
                [paginator]="true" 
                [rows]="10"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                [rowsPerPageOptions]="[10,25,50]"
                styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="name">
                            Tenant Name 
                            <p-sortIcon field="name"></p-sortIcon>
                        </th>
                        <th pSortableColumn="domain">
                            Domain
                            <p-sortIcon field="domain"></p-sortIcon>
                        </th>
                        <th pSortableColumn="email">
                            Email
                            <p-sortIcon field="email"></p-sortIcon>
                        </th>
                        <th pSortableColumn="phone1">
                            Phone
                        </th>
                        <th pSortableColumn="approvalStatus">
                            Status
                            <p-sortIcon field="approvalStatus"></p-sortIcon>
                        </th>
                        <th pSortableColumn="createdAt">
                            Registered
                            <p-sortIcon field="createdAt"></p-sortIcon>
                        </th>
                        <th>Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-tenant>
                    <tr>
                        <td>{{ tenant.name }}</td>
                        <td>{{ tenant.domain }}</td>
                        <td>{{ tenant.email }}</td>
                        <td>{{ tenant.phone1 || '-' }}</td>
                        <td>
                            <p-tag 
                                [value]="getStatusLabel(tenant.approvalStatus)" 
                                [severity]="getStatusSeverity(tenant.approvalStatus)">
                            </p-tag>
                        </td>
                        <td>{{ tenant.createdAt | date:'short' }}</td>
                        <td>
                            <button 
                                pButton 
                                type="button" 
                                icon="pi pi-eye" 
                                class="p-button-rounded p-button-text"
                                (click)="viewTenantDetails(tenant.id)"
                                pTooltip="View Details">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center">No tenant registrations found.</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<!-- Tenant Detail Dialog -->
<p-dialog 
    [(visible)]="showDetailDialog" 
    [modal]="true" 
    [style]="{width: '50vw'}"
    [draggable]="false"
    [resizable]="false"
    header="Tenant Details">
    <div *ngIf="selectedTenant()">
        <div class="grid">
            <div class="col-12">
                <p-card>
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <strong>Tenant Name:</strong><br>
                            {{ selectedTenant()!.name }}
                        </div>
                        <div class="col-12 md:col-6">
                            <strong>Domain:</strong><br>
                            {{ selectedTenant()!.domain }}
                        </div>
                        <div class="col-12 md:col-6">
                            <strong>Email:</strong><br>
                            {{ selectedTenant()!.email }}
                        </div>
                        <div class="col-12 md:col-6">
                            <strong>Phone:</strong><br>
                            {{ selectedTenant()!.phone1 || '-' }}
                        </div>
                        <div class="col-12 md:col-6" *ngIf="selectedTenant()!.phone2">
                            <strong>Phone 2:</strong><br>
                            {{ selectedTenant()!.phone2 }}
                        </div>
                        <div class="col-12 md:col-6" *ngIf="selectedTenant()!.registrationNumber">
                            <strong>Registration Number:</strong><br>
                            {{ selectedTenant()!.registrationNumber }}
                        </div>
                        <div class="col-12" *ngIf="selectedTenant()!.address">
                            <strong>Address:</strong><br>
                            {{ selectedTenant()!.address }}
                        </div>
                        <div class="col-12 md:col-6" *ngIf="selectedTenant()!.type">
                            <strong>Type:</strong><br>
                            {{ selectedTenant()!.type }}
                        </div>
                        <div class="col-12 md:col-6">
                            <strong>Status:</strong><br>
                            <p-tag 
                                [value]="getStatusLabel(selectedTenant()!.approvalStatus)" 
                                [severity]="getStatusSeverity(selectedTenant()!.approvalStatus)">
                            </p-tag>
                        </div>
                        <div class="col-12 md:col-6">
                            <strong>Registered:</strong><br>
                            {{ selectedTenant()!.createdAt | date:'medium' }}
                        </div>
                        <div class="col-12 md:col-6" *ngIf="selectedTenant()!.reviewedAt">
                            <strong>Reviewed:</strong><br>
                            {{ selectedTenant()!.reviewedAt | date:'medium' }}
                        </div>
                        <div class="col-12 md:col-6" *ngIf="selectedTenant()!.reviewedByName">
                            <strong>Reviewed By:</strong><br>
                            {{ selectedTenant()!.reviewedByName }}
                        </div>
                        <div class="col-12" *ngIf="selectedTenant()!.rejectionReason">
                            <strong>Rejection Reason:</strong><br>
                            <p class="text-red-500">{{ selectedTenant()!.rejectionReason }}</p>
                        </div>
                        <div class="col-12" *ngIf="selectedTenant()!.changeRequestReason">
                            <strong>Change Request:</strong><br>
                            <p class="text-blue-500">{{ selectedTenant()!.changeRequestReason }}</p>
                        </div>
                    </div>
                </p-card>
            </div>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <button 
            pButton 
            type="button" 
            label="Approve" 
            icon="pi pi-check" 
            class="p-button-success"
            (click)="openApproveDialog()"
            *ngIf="selectedTenant()?.approvalStatus === TenantApprovalStatus.Pending || selectedTenant()?.approvalStatus === TenantApprovalStatus.ChangeRequested">
        </button>
        <button 
            pButton 
            type="button" 
            label="Request Changes" 
            icon="pi pi-pencil" 
            class="p-button-info"
            (click)="openRequestChangeDialog()"
            *ngIf="selectedTenant()?.approvalStatus === TenantApprovalStatus.Pending">
        </button>
        <button 
            pButton 
            type="button" 
            label="Reject" 
            icon="pi pi-times" 
            class="p-button-danger"
            (click)="openRejectDialog()"
            *ngIf="selectedTenant()?.approvalStatus === TenantApprovalStatus.Pending || selectedTenant()?.approvalStatus === TenantApprovalStatus.ChangeRequested">
        </button>
        <button 
            pButton 
            type="button" 
            label="Close" 
            icon="pi pi-times" 
            class="p-button-text"
            (click)="closeAllDialogs()">
        </button>
    </ng-template>
</p-dialog>

<!-- Approve Dialog -->
<p-dialog 
    [(visible)]="showApproveDialog" 
    [modal]="true" 
    [style]="{width: '30vw'}"
    header="Approve Tenant">
    <p>Are you sure you want to approve <strong>{{ selectedTenant()?.name }}</strong>?</p>
    <p>An approval notification will be sent to <strong>{{ selectedTenant()?.email }}</strong>.</p>
    <ng-template pTemplate="footer">
        <button 
            pButton 
            type="button" 
            label="Cancel" 
            icon="pi pi-times" 
            class="p-button-text"
            (click)="showApproveDialog.set(false)">
        </button>
        <button 
            pButton 
            type="button" 
            label="Approve" 
            icon="pi pi-check" 
            class="p-button-success"
            [disabled]="loading()"
            (click)="approveTenant()">
        </button>
    </ng-template>
</p-dialog>

<!-- Reject Dialog -->
<p-dialog 
    [(visible)]="showRejectDialog" 
    [modal]="true" 
    [style]="{width: '30vw'}"
    header="Reject Tenant">
    <div class="field">
        <label for="rejectionReason">Rejection Reason *</label>
        <textarea 
            id="rejectionReason"
            pInputTextarea 
            [(ngModel)]="rejectionReason"
            rows="5" 
            class="w-full"
            placeholder="Provide reason for rejection...">
        </textarea>
    </div>
    <ng-template pTemplate="footer">
        <button 
            pButton 
            type="button" 
            label="Cancel" 
            icon="pi pi-times" 
            class="p-button-text"
            (click)="showRejectDialog.set(false)">
        </button>
        <button 
            pButton 
            type="button" 
            label="Reject" 
            icon="pi pi-times" 
            class="p-button-danger"
            [disabled]="loading() || !rejectionReason.trim()"
            (click)="rejectTenant()">
        </button>
    </ng-template>
</p-dialog>

<!-- Request Change Dialog -->
<p-dialog 
    [(visible)]="showRequestChangeDialog" 
    [modal]="true" 
    [style]="{width: '30vw'}"
    header="Request Changes">
    <div class="field">
        <label for="changeRequestReason">Changes Required *</label>
        <textarea 
            id="changeRequestReason"
            pInputTextarea 
            [(ngModel)]="changeRequestReason"
            rows="5" 
            class="w-full"
            placeholder="Describe what changes are needed...">
        </textarea>
    </div>
    <ng-template pTemplate="footer">
        <button 
            pButton 
            type="button" 
            label="Cancel" 
            icon="pi pi-times" 
            class="p-button-text"
            (click)="showRequestChangeDialog.set(false)">
        </button>
        <button 
            pButton 
            type="button" 
            label="Send Request" 
            icon="pi pi-send" 
            class="p-button-info"
            [disabled]="loading() || !changeRequestReason.trim()"
            (click)="requestChange()">
        </button>
    </ng-template>
</p-dialog>
